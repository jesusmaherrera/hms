from django.http import HttpResponse
from django.shortcuts import render_to_response
from hms.main.models import Contact
import sys
import xlrd
import MySQLdb
from django.utils.encoding import smart_str, smart_unicode

# Create your views here.

def search_form(request):
    return render_to_response('search_form.html')

def subirDatos(request):
    doc = xlrd.open_workbook('/home/chunel/MEDICOS.xls')
    sheet = doc.sheet_by_index(0)

    nrows = sheet.nrows
    sim = []



    db = MySQLdb.connect(user='hmsuser', db='hms_db', passwd='hms', host='localhost') 
    cursor = db.cursor()
    print(nrows)

    for i in range(nrows):
        valores = []
        insert_query = ""
        print("%s algo "% insert_query)
        valores.append(2)                          # contact_type_id
        valores.append("")                         # description
        valores.append("")                         # email
        valores.append(smart_str(sheet.cell_value(i,0)).replace("'","")) # first_name
        valores.append(smart_str(sheet.cell_value(i,5)).replace("'","")) # home_phones
        valores.append(sheet.cell_value(i,1).value) # last_name
        print(sheet.cell_value(i,1))
        valores.append(smart_str(sheet.cell_value(i,4)).replace("'","")) # office_phones
        valores.append(smart_str(sheet.cell_value(i,3)).replace("'","")) # personal_phones
        valores.append(smart_str(sheet.cell_value(i,2)).replace("'","")) # specialty
        insert_query = 'insert into main_contact(contact_type_id, description, email, first_name, home_phones, last_name, office_phones, personal_phones, specialty) values %s;'% str(tuple(valores))
        print(insert_query)
        #try:
        # Execute the SQL command
        #cursor.execute(insert_query)
        # Commit your changes in the database
        #db.commit()
        #except:
        # Rollback in case there is any error
        #print("ERROR")
        #db.rollback()

    # disconnect from server
    db.close()
    return HttpResponse(insert_query)

def search(request):
    if 'nombre' in request.GET and request.GET['nombre']:
	nombre = request.GET['nombre']
        contacts = Contact.objects.filter(first_name__icontains=nombre)
	return render_to_response('search_results.html',{'doctores':contacts, 'nombre':nombre})
    else:
        return HttpResponse('Por favor introduce un nombre a buscar.')
